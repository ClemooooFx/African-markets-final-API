name: Update Market Data
on:
  schedule:
    # Every 15 minutes during market hours (adjust timezone as needed)
    - cron: '*/15 3-13 * * 1-5'  # Mon-Fri, 3am-1pm UTC
  workflow_dispatch: # Manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install afrimarket pandas requests
      
      # Diagnostic step - check network and IP
      - name: Network diagnostics
        run: |
          echo "=== Runner IP Address ==="
          curl -s https://api.ipify.org
          echo ""
          echo "=== Testing connectivity to afx.kwayisi.org ==="
          curl -v --max-time 10 https://afx.kwayisi.org || echo "Connection failed"
          echo ""
          echo "=== DNS Resolution ==="
          nslookup afx.kwayisi.org || echo "DNS failed"
      
      - name: Run export script
        run: |
          python export_market_data.py
        continue-on-error: true
        id: export
      
      - name: Check export results
        run: |
          echo "Checking for exported files..."
          ls -la market_data/ || echo "No market_data directory"
          if [ -d "market_data" ] && [ "$(ls -A market_data)" ]; then
            echo "âœ“ Files exported successfully"
            echo "export_success=true" >> $GITHUB_OUTPUT
          else
            echo "âœ— No files exported - likely IP blocking issue"
            echo "export_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        id: check_export
      
      - name: Commit and push if changes
        if: steps.check_export.outputs.export_success == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add market_data/
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update market data - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Market Data Export Failed',
              body: `The market data export failed at ${new Date().toISOString()}\n\nThis is likely due to IP blocking after upgrading to GitHub Pro.\n\n**Possible solutions:**\n1. Use a proxy service\n2. Use self-hosted runner\n3. Use GitHub Free plan runners\n4. Contact afx.kwayisi.org about whitelisting\n\nCheck the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['bug', 'automated']
            })
