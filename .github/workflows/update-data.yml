name: Update Market Data (with Tor)
on:
  schedule:
    # Every 15 minutes during market hours (adjust timezone as needed)
    - cron: '*/15 3-13 * * 1-5'  # Mon-Fri, 3am-1pm UTC
  workflow_dispatch: # Manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # Install and configure Tor
      - name: Install Tor
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo service tor start
          sleep 5
          echo "Tor is running on SOCKS5 localhost:9050"
      
      - name: Install Python dependencies
        run: |
          pip install afrimarket pandas requests[socks]
      
      # Modify the Python script to use Tor
      - name: Configure script for Tor
        run: |
          cat > export_with_tor.py << 'EOF'
          import os
          os.environ['HTTP_PROXY'] = 'socks5h://127.0.0.1:9050'
          os.environ['HTTPS_PROXY'] = 'socks5h://127.0.0.1:9050'
          
          # Now import and run the original script
          exec(open('export_market_data.py').read())
          EOF
      
      - name: Test Tor connection
        run: |
          curl --socks5-hostname 127.0.0.1:9050 https://check.torproject.org/api/ip
          echo ""
          echo "Testing afx.kwayisi.org through Tor:"
          curl --socks5-hostname 127.0.0.1:9050 --max-time 10 https://afx.kwayisi.org || echo "Still blocked or connection issue"
      
      - name: Run export script through Tor
        run: |
          python export_with_tor.py
      
      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add market_data/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update market data - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Market Data Export Failed',
              body: `The market data export failed at ${new Date().toISOString()}\n\nThis is likely due to IP blocking after upgrading to GitHub Pro.\n\n**Possible solutions:**\n1. Use a proxy service\n2. Use self-hosted runner\n3. Use GitHub Free plan runners\n4. Contact afx.kwayisi.org about whitelisting\n\nCheck the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['bug', 'automated']
            })
